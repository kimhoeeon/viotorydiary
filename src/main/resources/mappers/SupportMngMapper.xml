<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.viotory.diary.mapper.SupportMngMapper">

    <select id="selectFaqList" resultType="com.viotory.diary.vo.FaqVO">
        SELECT * FROM faqs
        ORDER BY sort_order ASC, created_at DESC
    </select>

    <select id="selectFaqById" resultType="com.viotory.diary.vo.FaqVO">
        SELECT * FROM faqs WHERE faq_id = #{faqId}
    </select>

    <insert id="insertFaq" parameterType="com.viotory.diary.vo.FaqVO">
        INSERT INTO faqs (category, question, answer, sort_order, is_visible, created_at, updated_at)
        VALUES (#{category}, #{question}, #{answer}, IFNULL(#{sortOrder}, 0), #{isVisible}, NOW(), NOW())
    </insert>

    <update id="updateFaq" parameterType="com.viotory.diary.vo.FaqVO">
        UPDATE faqs
        SET category = #{category},
            question = #{question},
            answer = #{answer},
            sort_order = #{sortOrder},
            is_visible = #{isVisible},
            updated_at = NOW()
        WHERE faq_id = #{faqId}
    </update>

    <delete id="deleteFaq">
        DELETE FROM faqs WHERE faq_id = #{faqId}
    </delete>

    <sql id="inquiryCriteria">
        <where>
            <if test="keyword != null and keyword != ''">
                AND (
                i.title LIKE CONCAT('%', #{keyword}, '%')
                OR m.nickname LIKE CONCAT('%', #{keyword}, '%')
                )
            </if>
            <if test="status != null and status != ''">
                AND i.status = #{status}
            </if>
        </where>
    </sql>

    <select id="selectInquiryList" resultType="com.viotory.diary.vo.InquiryVO">
        SELECT
        i.*,
        m.nickname AS memberName,
        m.email AS memberEmail
        FROM inquiries i
        JOIN members m ON i.member_id = m.member_id
        <include refid="inquiryCriteria"/>
        ORDER BY i.status ASC, i.created_at DESC -- 대기중인 것 우선 노출
        LIMIT #{amount} OFFSET ${(pageNum - 1) * amount}
    </select>

    <select id="getInquiryTotalCount" resultType="int">
        SELECT COUNT(*)
        FROM inquiries i
        JOIN members m ON i.member_id = m.member_id
        <include refid="inquiryCriteria"/>
    </select>

    <select id="selectInquiryById" resultType="com.viotory.diary.vo.InquiryVO">
        SELECT
            i.*,
            m.nickname AS memberName,
            m.email AS memberEmail
        FROM inquiries i
                 JOIN members m ON i.member_id = m.member_id
        WHERE i.inquiry_id = #{inquiryId}
    </select>

    <update id="updateInquiryAnswer">
        UPDATE inquiries
        SET answer = #{answer},
            status = 'COMPLETED',
            answered_at = NOW()
        WHERE inquiry_id = #{inquiryId}
    </update>

</mapper>