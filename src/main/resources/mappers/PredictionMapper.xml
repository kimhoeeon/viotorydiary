<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.viotory.diary.mapper.PredictionMapper">

    <insert id="savePrediction">
        INSERT INTO predictions (member_id, game_id, predicted_team, created_at)
        VALUES (#{memberId}, #{gameId}, #{predictedTeam}, NOW())
        ON DUPLICATE KEY UPDATE
                             predicted_team = #{predictedTeam},
                             updated_at = NOW()
    </insert>

    <select id="selectMyPredictionHistory" resultType="com.viotory.diary.vo.PredictionVO">
        SELECT
            p.*,
            g.game_date, g.game_time, g.score_home, g.score_away, g.status as gameStatus,
            t1.name_kr AS homeTeamName, t1.team_code AS homeTeamCode,
            t2.name_kr AS awayTeamName, t2.team_code AS awayTeamCode,
            s.name AS stadiumName
        FROM predictions p
                 JOIN games g ON p.game_id = g.game_id
                 LEFT JOIN teams t1 ON g.home_team_code = t1.team_code
                 LEFT JOIN teams t2 ON g.away_team_code = t2.team_code
                 LEFT JOIN stadiums s ON g.stadium_id = s.stadium_id
        WHERE p.member_id = #{memberId}
        ORDER BY g.game_date DESC, g.game_time DESC
    </select>

    <select id="selectMyPredictionByGameId" resultType="com.viotory.diary.vo.PredictionVO">
        SELECT * FROM predictions
        WHERE member_id = #{memberId} AND game_id = #{gameId}
    </select>

    <select id="selectPredictionStats" resultType="map">
        SELECT
            COUNT(*) as total,
            COUNT(CASE WHEN is_correct = 1 THEN 1 END) as success
        FROM predictions
        WHERE member_id = #{memberId}
          AND is_correct IS NOT NULL
    </select>

    <select id="selectPredictionsByGameId" resultType="com.viotory.diary.vo.PredictionVO">
        SELECT * FROM predictions
        WHERE game_id = #{gameId}
    </select>

    <update id="updatePredictionResult">
        UPDATE predictions
        SET is_correct = #{isCorrect},
            updated_at = NOW()
        WHERE prediction_id = #{predictionId}
    </update>

    <update id="updateAlarmSent">
        UPDATE predictions
        SET is_alarm_sent = 1
        WHERE prediction_id = #{predictionId}
    </update>

</mapper>