<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.viotory.diary.mapper.GameMapper">

    <insert id="upsertGame" parameterType="com.viotory.diary.vo.GameVO">
        INSERT INTO games (
            api_game_id, game_date, game_time, stadium_id,
            home_team_code, away_team_code, score_home, score_away,
            status, cancel_reason, mvp_player, data_source, created_at
        ) VALUES (
                     #{apiGameId}, #{gameDate}, #{gameTime}, #{stadiumId},
                     #{homeTeamCode}, #{awayTeamCode}, #{scoreHome}, #{scoreAway},
                     #{status}, #{cancelReason}, #{mvpPlayer}, 'API', NOW()
                 )
        ON DUPLICATE KEY UPDATE
                             game_time = VALUES(game_time),
                             score_home = VALUES(score_home),
                             score_away = VALUES(score_away),
                             status = VALUES(status),
                             cancel_reason = VALUES(cancel_reason),
                             mvp_player = VALUES(mvp_player),
                             updated_at = NOW()
    </insert>

    <select id="selectGameByDateAndTeams" resultType="com.viotory.diary.vo.GameVO">
        SELECT * FROM games
        WHERE game_date = #{gameDate}
          AND home_team_code = #{homeTeam}
          AND away_team_code = #{awayTeam}
    </select>

    <select id="selectGameByDateAndTeam" resultType="com.viotory.diary.vo.GameVO">
        SELECT * FROM games
        WHERE game_date = #{gameDate}
          AND (home_team_code = #{teamCode} OR away_team_code = #{teamCode})
        LIMIT 1
    </select>

    <select id="selectTodayGameByTeam" resultType="com.viotory.diary.vo.GameVO">
        SELECT * FROM games
        WHERE (home_team_code = #{teamCode} OR away_team_code = #{teamCode})
          AND game_date = CURDATE()
        LIMIT 1
    </select>

    <select id="selectGamesByDate" resultType="com.viotory.diary.vo.GameVO">
        SELECT
            g.*,
            t1.name_kr AS homeTeamName,
            t2.name_kr AS awayTeamName,
            s.name AS stadiumName
        FROM games g
                 LEFT JOIN teams t1 ON g.home_team_code = t1.team_code
                 LEFT JOIN teams t2 ON g.away_team_code = t2.team_code
                 LEFT JOIN stadiums s ON g.stadium_id = s.stadium_id
        WHERE g.game_date = #{date}
        ORDER BY g.game_time ASC
    </select>

    <select id="selectTodayGame" resultType="com.viotory.diary.vo.GameVO">
        SELECT
            g.*,
            t1.name_kr AS homeTeamName,
            t2.name_kr AS awayTeamName,
            s.name AS stadiumName
        FROM games g
                 JOIN teams t1 ON g.home_team_code = t1.team_code
                 JOIN teams t2 ON g.away_team_code = t2.team_code
                 JOIN stadiums s ON g.stadium_id = s.stadium_id
        WHERE g.game_date = CURRENT_DATE()
          AND (g.home_team_code = #{teamCode} OR g.away_team_code = #{teamCode})
    </select>

    <select id="selectGameById" resultType="com.viotory.diary.vo.GameVO">
        SELECT
            g.*,
            s.name AS stadiumName,
            t1.name_kr AS homeTeamName,
            t2.name_kr AS awayTeamName
        FROM games g
                 LEFT JOIN stadiums s ON g.stadium_id = s.stadium_id
                 LEFT JOIN teams t1 ON g.home_team_code = t1.team_code
                 LEFT JOIN teams t2 ON g.away_team_code = t2.team_code
        WHERE g.game_id = #{gameId}
    </select>

    <update id="updateGameScoreAndStatus">
        UPDATE games
        SET score_home = #{scoreHome},
            score_away = #{scoreAway},
            status = #{status},
            /* winningTeam 파라미터 값("HOME" 등)을 무시하고, 실제 팀 코드를 넣는 로직 */
            winning_team = CASE
                               WHEN #{status} = 'FINISHED' AND #{scoreHome} > #{scoreAway} THEN home_team_code
                               WHEN #{status} = 'FINISHED' AND #{scoreAway} > #{scoreHome} THEN away_team_code
                               WHEN #{status} = 'FINISHED' AND #{scoreHome} = #{scoreAway} THEN 'DRAW'
                               ELSE NULL
                END,
            updated_at = NOW()
        WHERE api_game_id = #{apiGameId}
    </update>

    <select id="selectGameByApiId" resultType="com.viotory.diary.vo.GameVO">
        SELECT * FROM games WHERE api_game_id = #{apiGameId}
    </select>

    <select id="selectStadiumById" resultType="com.viotory.diary.vo.StadiumVO">
        SELECT * FROM stadiums WHERE stadium_id = #{stadiumId}
    </select>

    <select id="selectGameListByMonth" resultType="com.viotory.diary.vo.GameVO">
        SELECT
            g.*,
            s.name AS stadiumName,
            t1.name_kr AS homeTeamName,
            t2.name_kr AS awayTeamName
        FROM games g
                 LEFT JOIN stadiums s ON g.stadium_id = s.stadium_id
                 LEFT JOIN teams t1 ON g.home_team_code = t1.team_code
                 LEFT JOIN teams t2 ON g.away_team_code = t2.team_code
        WHERE g.game_date LIKE CONCAT(#{yearMonth}, '%')
        ORDER BY g.game_date ASC, g.game_time ASC
    </select>

    <select id="countTodayGames" resultType="int">
        SELECT COUNT(*) FROM games WHERE game_date = CURDATE()
    </select>

</mapper>