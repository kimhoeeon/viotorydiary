<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.viotory.diary.mapper.DiaryMapper">

    <select id="selectVerifiedDiaries" parameterType="long" resultType="com.viotory.diary.vo.DiaryVO">
        <![CDATA[
        SELECT
            d.diary_id,
            d.member_id,
            d.game_id,
            d.snapshot_team_code,
            d.is_verified,
            d.verified_at,
            g.game_date,

            /* 승/패/무 판별 로직 */
            CASE
                /* 1. 내가 홈팀을 응원했을 때 */
                WHEN d.snapshot_team_code = g.home_team_code THEN
                    CASE
                        WHEN g.score_home > g.score_away THEN 'WIN'
                        WHEN g.score_home < g.score_away THEN 'LOSE'
                        ELSE 'DRAW'
                        END

                /* 2. 내가 원정팀을 응원했을 때 */
                WHEN d.snapshot_team_code = g.away_team_code THEN
                    CASE
                        WHEN g.score_away > g.score_home THEN 'WIN'
                        WHEN g.score_away < g.score_home THEN 'LOSE'
                        ELSE 'DRAW'
                        END

                ELSE 'NONE'
                END AS gameResult

        FROM diaries d
                 INNER JOIN games g ON d.game_id = g.game_id
        WHERE
            d.member_id = #{memberId}
          AND d.is_verified = 1       /* 직관 인증 완료 */
          AND g.status = 'FINISHED'   /* 경기 종료 */
          AND d.status != 'INVALID'   /* 유효한 일기 */
        ORDER BY
            g.game_date DESC, g.game_time DESC
        ]]>
    </select>

</mapper>