<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.viotory.diary.mapper.DiaryMapper">

    <select id="selectVerifiedDiaries" parameterType="long" resultType="com.viotory.diary.vo.DiaryVO">
        <![CDATA[
        SELECT d.diary_id,
               d.member_id,
               d.game_id,
               d.snapshot_team_code,
               d.is_verified,
               d.verified_at,
               g.game_date,
               s.name  AS stadiumName,
            /* 승패 판별 로직 */
               CASE
                   WHEN d.snapshot_team_code = g.home_team_code THEN
                       CASE
                           WHEN g.score_home > g.score_away THEN 'WIN'
                           WHEN g.score_home < g.score_away THEN 'LOSE'
                           ELSE 'DRAW'
                           END
                   WHEN d.snapshot_team_code = g.away_team_code THEN
                       CASE
                           WHEN g.score_away > g.score_home THEN 'WIN'
                           WHEN g.score_away < g.score_home THEN 'LOSE'
                           ELSE 'DRAW'
                           END
                   ELSE 'NONE'
                   END AS gameResult
        FROM diaries d
                 INNER JOIN games g ON d.game_id = g.game_id
                 INNER JOIN stadiums s ON g.stadium_id = s.stadium_id
        WHERE d.member_id = #{memberId}
          AND d.is_verified = 1
          AND g.status = 'FINISHED'
          AND d.status = 'COMPLETED' /* [중요] 삭제된 글('DELETED') 제외 */
        ORDER BY g.game_date DESC
        ]]>
    </select>

    <select id="selectDiaryByMemberAndGame" resultType="com.viotory.diary.vo.DiaryVO">
        SELECT *
        FROM diaries
        WHERE member_id = #{memberId}
          AND game_id = #{gameId}
          AND status != 'INVALID'
        LIMIT 1
    </select>

    <update id="updateDiary" parameterType="com.viotory.diary.vo.DiaryVO">
        UPDATE diaries
        SET hero_name        = #{heroName},
            content          = #{content},
            one_line_comment = #{oneLineComment},
            rating           = #{rating},
            is_public        = #{isPublic},
            pred_score_home  = #{predScoreHome},
            pred_score_away  = #{predScoreAway},
            image_url        = #{imageUrl},
            updated_at       = NOW()
        WHERE diary_id = #{diaryId}
          AND member_id = #{memberId}
    </update>

    <select id="selectWinYoRankingTop10" resultType="com.viotory.diary.dto.WinYoAnalysisDTO">
        <![CDATA[
        SELECT m.nickname,
               COUNT(d.diary_id)                               AS totalGames,
               SUM(CASE
                       WHEN (d.snapshot_team_code = g.home_team_code AND g.score_home > g.score_away) OR
                            (d.snapshot_team_code = g.away_team_code AND g.score_away > g.score_home)
                           THEN 1
                       ELSE 0 END)                             AS winGames,
               (SUM(CASE
                        WHEN (d.snapshot_team_code = g.home_team_code AND g.score_home > g.score_away) OR
                             (d.snapshot_team_code = g.away_team_code AND g.score_away > g.score_home)
                            THEN 1
                        ELSE 0 END) / COUNT(d.diary_id)) * 100 AS winRate
        FROM diaries d
                 JOIN games g ON d.game_id = g.game_id
                 JOIN members m ON d.member_id = m.member_id
        WHERE d.is_verified = 1
          AND g.status = 'FINISHED'
          AND d.status != 'INVALID'
        GROUP BY d.member_id
        HAVING totalGames >= 5 /* 최소 5경기 이상 직관한 사람만 랭킹 대상 */
        ORDER BY winGames DESC, winRate DESC
        LIMIT 10
        ]]>
    </select>

    <select id="selectRecentDiaries" resultType="com.viotory.diary.vo.DiaryVO">
        SELECT
            d.diary_id,
            d.game_id,
            d.one_line_comment, /* 메인화면 표시용 */
            g.game_date,
            g.home_team_code,
            g.away_team_code,
            g.score_home,
            g.score_away,
            t1.name_kr AS homeTeamName, /* 팀 이름 추가 */
            t2.name_kr AS awayTeamName, /* 팀 이름 추가 */
            s.name AS stadiumName,      /* 구장 이름 추가 */

            /* 승패 판별 로직 */
            CASE
                WHEN d.snapshot_team_code = g.home_team_code AND g.score_home > g.score_away THEN 'WIN'
                WHEN d.snapshot_team_code = g.home_team_code AND g.score_home &lt; g.score_away THEN 'LOSE'
                WHEN d.snapshot_team_code = g.away_team_code AND g.score_away > g.score_home THEN 'WIN'
                WHEN d.snapshot_team_code = g.away_team_code AND g.score_away &lt; g.score_home THEN 'LOSE'
                WHEN g.score_home = g.score_away THEN 'DRAW'
                ELSE 'NONE'
                END AS gameResult
        FROM diaries d
                 JOIN games g ON d.game_id = g.game_id
                 LEFT JOIN teams t1 ON g.home_team_code = t1.team_code
                 LEFT JOIN teams t2 ON g.away_team_code = t2.team_code
                 LEFT JOIN stadiums s ON g.stadium_id = s.stadium_id
        WHERE d.member_id = #{memberId}
          AND d.status = 'COMPLETED' /* [중요] 삭제된 글 제외 */
        ORDER BY g.game_date DESC
        LIMIT 3
    </select>

    <insert id="insertDiary" parameterType="com.viotory.diary.vo.DiaryVO" useGeneratedKeys="true" keyProperty="diaryId">
        INSERT INTO diaries (member_id, game_id, snapshot_team_code,
                             pred_score_home, pred_score_away, pred_hero, hero_name,
                             content, one_line_comment, rating,
                             image_url,
                             status, is_public, created_at, updated_at)
        VALUES (#{memberId}, #{gameId}, #{snapshotTeamCode},
                #{predScoreHome}, #{predScoreAway}, #{predHero}, #{heroName},
                #{content}, #{oneLineComment}, #{rating},
                #{imageUrl},
                'COMPLETED', IFNULL(#{isPublic}, 'PUBLIC'), NOW(), NOW())
    </insert>

    <select id="selectDiaryById" resultType="com.viotory.diary.vo.DiaryVO">
        SELECT
            d.*,
            m.nickname,
            m.profile_image,

            /* 경기 정보 및 팀명 */
            g.game_date,
            g.game_time,
            s.name AS stadiumName,
            t1.name_kr AS homeTeamName,
            t2.name_kr AS awayTeamName,

            /* 팀 로고 조회 */
            t1.logo_image_url AS homeTeamLogo,
            t2.logo_image_url AS awayTeamLogo,

            g.score_home,
            g.score_away,
            g.home_team_code,
            g.away_team_code

        FROM diaries d
                 JOIN members m ON d.member_id = m.member_id
                 JOIN games g ON d.game_id = g.game_id
                 LEFT JOIN stadiums s ON g.stadium_id = s.stadium_id

            /* 팀 정보 조인 (로고 조회를 위해 필수) */
                 LEFT JOIN teams t1 ON g.home_team_code = t1.team_code
                 LEFT JOIN teams t2 ON g.away_team_code = t2.team_code

        WHERE d.diary_id = #{diaryId}
    </select>

    <select id="selectDiaryList" resultType="com.viotory.diary.vo.DiaryVO">
        SELECT d.diary_id,
               d.member_id,
               d.one_line_comment,
               d.rating,
               d.game_id,
               g.game_date,
               g.game_time,
               g.home_team_code,
               g.away_team_code,
               g.score_home,
               g.score_away,
               t1.name_kr AS homeTeamName,
               t2.name_kr AS awayTeamName,
               s.name     AS stadiumName,

               -- 승패 판별 (승요 서비스 로직과 동일)
               CASE
                   WHEN g.winning_team = d.snapshot_team_code THEN 'WIN'
                   WHEN g.winning_team = 'DRAW' THEN 'DRAW'
                   WHEN g.winning_team IS NOT NULL THEN 'LOSE'
                   ELSE 'NONE' -- 경기 전 or 취소
                   END    AS gameResult

        FROM diaries d
                 JOIN games g ON d.game_id = g.game_id
                 LEFT JOIN teams t1 ON g.home_team_code = t1.team_code
                 LEFT JOIN teams t2 ON g.away_team_code = t2.team_code
                 LEFT JOIN stadiums s ON g.stadium_id = s.stadium_id
        WHERE d.member_id = #{memberId}
          AND d.status = 'COMPLETED'
        ORDER BY g.game_date DESC, g.game_time DESC
    </select>

    <select id="selectFriendDiaryList" resultType="com.viotory.diary.vo.DiaryVO">
        SELECT d.diary_id,
               d.member_id,
               d.one_line_comment,
               d.rating,
               g.game_date,
               g.home_team_code,
               g.away_team_code,
               g.score_home,
               g.score_away,
               t1.name_kr     AS homeTeamName,
               t2.name_kr     AS awayTeamName,
               m.nickname,
               m.profile_image,
               m.my_team_code AS snapshotTeamCode,
               t1.logo_image_url AS homeTeamLogo,
               t2.logo_image_url AS awayTeamLogo,
               CASE
                   WHEN g.winning_team = m.my_team_code THEN 'WIN'
                   WHEN g.winning_team = 'DRAW' THEN 'DRAW'
                   WHEN g.winning_team IS NOT NULL THEN 'LOSE'
                   ELSE 'NONE'
                   END        AS gameResult
        FROM diaries d
                 JOIN follows f ON d.member_id = f.following_id
                 JOIN members m ON d.member_id = m.member_id
                 JOIN games g ON d.game_id = g.game_id
                 LEFT JOIN teams t1 ON g.home_team_code = t1.team_code
                 LEFT JOIN teams t2 ON g.away_team_code = t2.team_code
        WHERE f.follower_id = #{memberId}
          AND d.status = 'COMPLETED'
          AND d.is_public IN ('PUBLIC', 'FRIENDS')
        ORDER BY g.game_date DESC
        LIMIT 3
    </select>

    <select id="selectVisitedStadiumIds" resultType="long">
        SELECT DISTINCT g.stadium_id
        FROM diaries d
                 JOIN games g ON d.game_id = g.game_id
        WHERE d.member_id = #{memberId}
          AND d.status = 'COMPLETED'
    </select>

    <update id="updateDiaryStatus">
        UPDATE diaries
        SET status     = #{status},
            updated_at = NOW()
        WHERE diary_id = #{diaryId}
          AND member_id = #{memberId} -- 본인 확인
    </update>

    <select id="selectAllFriendDiaries" resultType="com.viotory.diary.vo.DiaryVO">
        SELECT d.diary_id,
               d.member_id,
               d.one_line_comment,
               d.rating,
               d.content,
               d.image_url,
               g.game_date,
               g.home_team_code,
               g.away_team_code,
               g.score_home,
               g.score_away,
               t1.name_kr     AS homeTeamName,
               t2.name_kr     AS awayTeamName,
               m.nickname,
               m.profile_image,
               m.my_team_code AS snapshotTeamCode,
               CASE
                   WHEN g.winning_team = m.my_team_code THEN 'WIN'
                   WHEN g.winning_team = 'DRAW' THEN 'DRAW'
                   WHEN g.winning_team IS NOT NULL THEN 'LOSE'
                   ELSE 'NONE'
                   END        AS gameResult
        FROM diaries d
                 JOIN follows f ON d.member_id = f.following_id
                 JOIN members m ON d.member_id = m.member_id
                 JOIN games g ON d.game_id = g.game_id
                 LEFT JOIN teams t1 ON g.home_team_code = t1.team_code
                 LEFT JOIN teams t2 ON g.away_team_code = t2.team_code
        WHERE f.follower_id = #{memberId}
          AND d.status = 'COMPLETED'
          AND d.is_public IN ('PUBLIC', 'FRIENDS')
        ORDER BY g.game_date DESC, d.created_at DESC
    </select>

    <update id="updateShareUuid">
        UPDATE diaries
        SET share_uuid = #{uuid}
        WHERE diary_id = #{diaryId}
    </update>

    <select id="selectDiaryByUuid" resultType="com.viotory.diary.vo.DiaryVO">
        SELECT d.*,
               g.game_date,
               g.game_time,
               g.home_team_code,
               g.away_team_code,
               g.score_home,
               g.score_away,
               t1.name_kr AS homeTeamName,
               t2.name_kr AS awayTeamName,
               s.name AS stadiumName,
               m.nickname,
               m.profile_image,
            /* 승패 판별 */
               CASE
                   WHEN g.winning_team = d.snapshot_team_code THEN 'WIN'
                   WHEN g.winning_team = 'DRAW' THEN 'DRAW'
                   WHEN g.winning_team IS NOT NULL THEN 'LOSE'
                   ELSE 'NONE'
                   END AS gameResult

        FROM diaries d
                 JOIN members m ON d.member_id = m.member_id
                 JOIN games g ON d.game_id = g.game_id
                 LEFT JOIN teams t1 ON g.home_team_code = t1.team_code
                 LEFT JOIN teams t2 ON g.away_team_code = t2.team_code
                 LEFT JOIN stadiums s ON g.stadium_id = s.stadium_id
        WHERE d.share_uuid = #{uuid}
          AND d.status = 'COMPLETED' /* 삭제된 글 노출 방지 */
        /* is_public 체크는 서비스 로직에서 처리 (삭제된 글 안내 등을 위해) */
    </select>

    <select id="countTotalDiaries" resultType="int">
        SELECT COUNT(*) FROM diaries WHERE status = 'COMPLETED'
    </select>

    <select id="countTodayDiaries" resultType="int">
        SELECT COUNT(*) FROM diaries WHERE status = 'COMPLETED' AND DATE(created_at) = CURDATE()
    </select>

</mapper>