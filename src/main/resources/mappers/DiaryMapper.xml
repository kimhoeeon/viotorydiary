<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.viotory.diary.mapper.DiaryMapper">

    <select id="selectVerifiedDiaries" parameterType="long" resultType="com.viotory.diary.vo.DiaryVO">
        <![CDATA[
        SELECT
            d.diary_id,
            d.member_id,
            d.game_id,
            d.snapshot_team_code,
            d.is_verified,
            d.verified_at,
            g.game_date,
            /* 승/패/무 판별 로직 */
            CASE
                /* 1. 내가 홈팀을 응원했을 때 */
                WHEN d.snapshot_team_code = g.home_team_code THEN
                    CASE
                        WHEN g.score_home > g.score_away THEN 'WIN'
                        WHEN g.score_home < g.score_away THEN 'LOSE'
                        ELSE 'DRAW'
                        END
                /* 2. 내가 원정팀을 응원했을 때 */
                WHEN d.snapshot_team_code = g.away_team_code THEN
                    CASE
                        WHEN g.score_away > g.score_home THEN 'WIN'
                        WHEN g.score_away < g.score_home THEN 'LOSE'
                        ELSE 'DRAW'
                        END
                ELSE 'NONE'
                END AS gameResult
        FROM diaries d
        INNER JOIN games g ON d.game_id = g.game_id
        WHERE d.member_id = #{memberId}
          AND d.is_verified = 1       /* 직관 인증 완료 */
          AND g.status = 'FINISHED'   /* 경기 종료 */
          AND d.status != 'INVALID'   /* 유효한 일기 */
        ORDER BY g.game_date DESC, g.game_time DESC
        ]]>
    </select>

    <select id="selectWinYoRankingTop10" resultType="com.viotory.diary.dto.WinYoAnalysisDTO">
        <![CDATA[
        SELECT
            m.member_id AS memberId,
            m.nickname AS nickname,
            COUNT(d.diary_id) AS totalGames,
            SUM(CASE
                    WHEN (d.snapshot_team_code = g.home_team_code AND g.score_home > g.score_away) OR
                         (d.snapshot_team_code = g.away_team_code AND g.score_away > g.score_home)
                        THEN 1 ELSE 0 END) AS winGames,
            /* 승률 계산: (승리수 / 전체수) * 100 */
            ROUND(
                    (SUM(CASE
                             WHEN (d.snapshot_team_code = g.home_team_code AND g.score_home > g.score_away) OR
                                  (d.snapshot_team_code = g.away_team_code AND g.score_away > g.score_home)
                                 THEN 1 ELSE 0 END) / COUNT(d.diary_id)) * 100
                , 1) AS winRate
        FROM diaries d
        JOIN games g ON d.game_id = g.game_id
        JOIN members m ON d.member_id = m.member_id
        WHERE d.is_verified = 1
          AND g.status = 'FINISHED'
          AND d.status != 'INVALID'
        GROUP BY d.member_id
        HAVING totalGames >= 3  /* 최소 3경기 이상 직관한 사람만 랭킹 인정 */
        ORDER BY winRate DESC, totalGames DESC
        LIMIT 10
        ]]>
    </select>

    <insert id="insertDiary" parameterType="com.viotory.diary.vo.DiaryVO" useGeneratedKeys="true" keyProperty="diaryId">
        INSERT INTO diaries (
            member_id,
            game_id,
            snapshot_team_code,
            is_verified,
            verified_at,
            content,
            one_line_comment,
            rating,
            status,
            is_public,
            created_at,
            updated_at
        ) VALUES (
                     #{memberId},
                     #{gameId},
                     #{snapshotTeamCode},
                     #{isVerified},
                     #{verifiedAt},
                     #{content},
                     #{oneLineComment},
                     #{rating},
                     'COMPLETED',
                     IFNULL(#{isPublic}, 'PUBLIC'),
                     NOW(),
                     NOW()
                 )
    </insert>

    <select id="selectDiaryById" parameterType="long" resultType="com.viotory.diary.vo.DiaryVO">
        SELECT * FROM diaries WHERE diary_id = #{diaryId}
    </select>

    <select id="selectDiaryByMemberAndGame" resultType="com.viotory.diary.vo.DiaryVO">
        SELECT * FROM diaries
        WHERE member_id = #{memberId}
          AND game_id = #{gameId}
          AND status != 'INVALID'
        LIMIT 1
    </select>

    <update id="updateDiary" parameterType="com.viotory.diary.vo.DiaryVO">
        UPDATE diaries
        SET
            content = #{content},
            one_line_comment = #{oneLineComment},
            rating = #{rating},
            is_public = #{isPublic},
            updated_at = NOW()
        WHERE diary_id = #{diaryId}
          AND member_id = #{memberId}
    </update>

</mapper>