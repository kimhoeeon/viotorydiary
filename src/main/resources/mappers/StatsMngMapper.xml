<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.viotory.diary.mapper.StatsMngMapper">

    <select id="selectWinRateRanking" resultType="com.viotory.diary.vo.UserStatsVO">
        <![CDATA[
        SELECT
            m.member_id,
            m.nickname,
            m.my_team_code,
            t.name_kr AS myTeamName,

            -- 직관 일기와 연결된 예측 횟수를 총 전적으로 계산
            COUNT(p.prediction_id) AS totalGames,

            -- 예측 적중(승)
            SUM(CASE WHEN p.is_correct = 1 THEN 1 ELSE 0 END) AS winGames,

            -- 예측 실패(패)
            SUM(CASE WHEN p.is_correct = 0 THEN 1 ELSE 0 END) AS loseGames,

            -- 예측 승률 시스템에서는 무승부가 없으므로 0으로 고정
            0 AS drawGames

        FROM diaries d
         JOIN members m ON d.member_id = m.member_id
         JOIN games g ON d.game_id = g.game_id
         JOIN predictions p ON p.member_id = d.member_id AND p.game_id = g.game_id
         LEFT JOIN teams t ON m.my_team_code = t.team_code
        WHERE d.status = 'COMPLETED'
          AND d.is_verified = 1
          AND g.status = 'FINISHED'
        GROUP BY m.member_id
        ORDER BY winGames DESC, totalGames DESC
        LIMIT 100
        ]]>
    </select>

    <select id="selectDau" resultType="int">
        SELECT COUNT(DISTINCT member_id)
        FROM access_logs
        WHERE login_date = CURDATE()
    </select>

    <select id="selectMau" resultType="int">
        <![CDATA[
        SELECT COUNT(DISTINCT member_id)
        FROM access_logs
        WHERE login_date >= DATE_SUB(CURDATE(), INTERVAL 30 DAY)
        ]]>
    </select>

    <select id="selectTotalAvgWinRate" resultType="double">
        <![CDATA[
        SELECT
            IFNULL(
                    (SUM(CASE
                             WHEN (d.snapshot_team_code = g.home_team_code AND g.score_home > g.score_away) THEN 1
                             WHEN (d.snapshot_team_code = g.away_team_code AND g.score_away > g.score_home) THEN 1
                             ELSE 0
                        END) * 100.0 / NULLIF(COUNT(d.diary_id), 0))
                , 0) AS avgWinRate
        FROM diaries d
        INNER JOIN games g ON d.game_id = g.game_id
        WHERE d.is_verified = 1
          AND g.status = 'FINISHED'
          AND d.status = 'COMPLETED'
          AND g.game_type IN ('REGULAR', 'POST', 'EXHIBITION')
        ]]>
    </select>

    <select id="selectAvgMonthlyDiaries" resultType="double">
        <![CDATA[
        SELECT IFNULL(COUNT(d.diary_id) / NULLIF(#{mau}, 0), 0) AS avgMonthlyDiaries
        FROM diaries d
        INNER JOIN games g ON d.game_id = g.game_id
        WHERE d.created_at >= DATE_SUB(CURDATE(), INTERVAL 1 MONTH)
          AND d.status = 'COMPLETED'
          AND g.status != 'CANCELLED'
        ]]>
    </select>

    <select id="selectWeeklyAccessStats" resultType="map">
        <![CDATA[
        SELECT DATE_FORMAT(login_date, '%Y-%m-%d') as logDate,
               COUNT(member_id) as cnt
        FROM access_logs
        WHERE login_date >= DATE_SUB(CURDATE(), INTERVAL 6 DAY)
        GROUP BY login_date
        ORDER BY login_date ASC
        ]]>
    </select>

</mapper>