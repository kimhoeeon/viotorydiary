<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.viotory.diary.mapper.DiaryMngMapper">

    <sql id="criteria">
        <where>
            <if test="keyword != null and keyword != ''">
                AND (
                d.content LIKE CONCAT('%', #{keyword}, '%')
                OR m.nickname LIKE CONCAT('%', #{keyword}, '%')
                )
            </if>
            <if test="status != null and status != ''">
                AND d.status = #{status}
            </if>
        </where>
    </sql>

    <select id="selectDiaryList" resultType="com.viotory.diary.vo.DiaryVO">
        SELECT
        d.diary_id,
        d.content,
        d.created_at,
        d.status,
        d.member_id,
        m.nickname AS memberName,
        g.game_date,
        t1.name_kr AS homeTeamName,
        t2.name_kr AS awayTeamName
        FROM diaries d
        JOIN members m ON d.member_id = m.member_id
        LEFT JOIN games g ON d.game_id = g.game_id
        LEFT JOIN teams t1 ON g.home_team_code = t1.team_code
        LEFT JOIN teams t2 ON g.away_team_code = t2.team_code
        <include refid="criteria"/>
        ORDER BY d.created_at DESC
        LIMIT #{amount} OFFSET ${(pageNum - 1) * amount}
    </select>

    <select id="getTotalCount" resultType="int">
        SELECT COUNT(*)
        FROM diaries d
        JOIN members m ON d.member_id = m.member_id
        <include refid="criteria"/>
    </select>

    <select id="selectDiaryById" resultType="com.viotory.diary.vo.DiaryVO">
        SELECT
            d.*,
            m.nickname AS memberName,
            m.email AS memberEmail,
            g.game_date,
            g.game_time,
            s.name AS stadiumName,
            t1.name_kr AS homeTeamName,
            t2.name_kr AS awayTeamName
        FROM diaries d
                 JOIN members m ON d.member_id = m.member_id
                 LEFT JOIN games g ON d.game_id = g.game_id
                 LEFT JOIN stadiums s ON g.stadium_id = s.stadium_id
                 LEFT JOIN teams t1 ON g.home_team_code = t1.team_code
                 LEFT JOIN teams t2 ON g.away_team_code = t2.team_code
        WHERE d.diary_id = #{diaryId}
    </select>

    <update id="deleteDiary">
        UPDATE diaries
        SET status = 'DELETED',
            updated_at = NOW()
        WHERE diary_id = #{diaryId}
    </update>

</mapper>